<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Abhijit's Chat App</title>
    <style>
        /* --- ধাপ ১: ডিজাইন (CSS) --- */
        /* --- বন্ধু, আমি এখানে তোর জন্য লাইট এবং ডার্ক দুটো থিমই বানিয়ে দিয়েছি --- */

        :root {
            /* ডার্ক থিম (মূল অ্যাপের জন্য) */
            --bg-dark: #121212;
            --bg-medium: #1e1e1e;
            --bg-light: #2d2d2d;
            --primary-color: #007bff;
            --secondary-color-dark: #3d3d3d;
            --text-primary-dark: #e0e0e0;
            --text-secondary-dark: #b0b0b0;
            --border-color-dark: #3a3a3c;
            
            /* লাইট থিম (লগইন স্ক্রিনের জন্য) */
            --bg-light-theme: #ffffff;
            --bg-medium-light-theme: #f8f9fa;
            --text-primary-light-theme: #212529;
            --text-secondary-light-theme: #6c757d;
            --border-color-light-theme: #dee2e6;

            /* কমন কালার */
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            background-color: var(--bg-dark); /* ডিফল্ট ডার্ক */
            color: var(--text-primary-dark);
        }

        /* --- স্ক্রিন ম্যানেজমেন্ট --- */
        .screen {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 20px;
            transition: opacity 0.3s ease;
        }
        .screen.active { display: flex; }
        
        /* --- সুন্দর লোডার --- */
        #loader-screen { background-color: var(--bg-dark); }
        #loader-screen .loader {
            border: 5px solid var(--bg-light);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- নতুন লাইট থিম ডিজাইন (লগইন ও ইউজারনেম স্ক্রিনের জন্য) --- */
        .light-theme {
            background-color: var(--bg-light-theme);
            color: var(--text-primary-light-theme);
        }
        .light-theme h1 { color: var(--primary-color); text-shadow: none; }
        .light-theme h2 { color: var(--text-primary-light-theme); }
        .light-theme p { color: var(--text-secondary-light-theme); }
        .light-theme .phone-btn {
            background-color: var(--bg-medium-light-theme);
            color: var(--text-primary-light-theme);
            border: 1px solid var(--border-color-light-theme);
        }
        .light-theme .input-field {
            background-color: #fff;
            border: 1px solid var(--border-color-light-theme);
            color: var(--text-primary-light-theme);
        }
        .light-theme .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        .light-theme #username-status.success { color: var(--success-color); }
        .light-theme #username-status.error { color: var(--error-color); }
        
        /* --- কমন বাটন স্টাইল --- */
        .btn {
            width: 100%; max-width: 320px; padding: 15px;
            border: none; border-radius: 8px; font-size: 1.1rem;
            font-weight: 600; cursor: pointer; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center;
            gap: 10px; transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .google-btn { background-color: #4285F4; color: white; }
        .primary-btn { background-color: var(--primary-color); color: white; }
        .primary-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        
        #phone-auth-section { display: none; width: 100%; max-width: 320px; margin-top: 20px; }
        .input-group { margin-bottom: 15px; }
        #otp-input-section { display: none; }

        /* --- মূল ডার্ক থিম অ্যাপের ডিজাইন --- */
        #main-app-screen { background-color: var(--bg-dark); }
        #sidebar {
            width: 350px; height: 100%;
            background-color: var(--bg-medium);
            border-right: 1px solid var(--border-color-dark);
            display: flex; flex-direction: column;
        }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border-color-dark); display: flex; flex-direction: column; gap: 10px; }
        .sidebar-tabs { display: flex; }
        .tab-btn { flex: 1; padding: 10px; background: none; border: none; color: var(--text-secondary-dark); cursor: pointer; border-bottom: 2px solid transparent; font-weight: 600; }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        #search-user-input { width: 100%; padding: 10px; background-color: var(--bg-light); border: 1px solid var(--border-color-dark); border-radius: 8px; color: var(--text-primary-dark); }
        .sidebar-content { flex-grow: 1; overflow-y: auto; }
        .user-item { display: flex; align-items: center; gap: 15px; padding: 15px; cursor: pointer; border-bottom: 1px solid var(--border-color-dark); justify-content: space-between; }
        .user-item:hover, .user-item.active { background-color: var(--bg-light); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background-color: var(--secondary-color-dark); color: white; display: flex; justify-content: center; align-items: center; font-weight: bold; font-size: 1.2rem; }
        .user-name { font-weight: 600; color: var(--text-primary-dark); }
        .request-actions button, .add-btn { background: none; border: 1px solid; border-radius: 5px; padding: 5px 10px; cursor: pointer; transition: background-color 0.2s; }
        .accept-btn { color: var(--success-color); border-color: var(--success-color); }
        .accept-btn:hover { background-color: rgba(40, 167, 69, 0.2); }
        .decline-btn { color: var(--error-color); border-color: var(--error-color); margin-left: 5px; }
        .decline-btn:hover { background-color: rgba(220, 53, 69, 0.2); }
        .add-btn { color: var(--primary-color); border-color: var(--primary-color); }
        .add-btn:hover { background-color: rgba(0, 123, 255, 0.2); }
        #chat-window { flex-grow: 1; display: flex; flex-direction: column; height: 100%; background-color: var(--bg-dark); }
        .chat-header { padding: 15px; background-color: var(--bg-light); border-bottom: 1px solid var(--border-color-dark); display: flex; align-items: center; gap: 15px; }
        .back-arrow { font-size: 1.5rem; cursor: pointer; display: none; margin-right: 10px; color: var(--text-primary-dark);}
        .messages-container { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .messages-wrapper { display: flex; flex-direction: column; }
        .message-bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; line-height: 1.5; word-wrap: break-word; }
        .my-message { background-color: var(--primary-color); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .friend-message { background-color: var(--bg-light); color: var(--text-primary-dark); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message-input-form { display: flex; padding: 15px; background-color: var(--bg-medium); border-top: 1px solid var(--border-color-dark); }
        #message-input { flex-grow: 1; background-color: var(--bg-light); border: 1px solid var(--border-color-dark); border-radius: 20px; padding: 10px 15px; color: var(--text-primary-dark); font-size: 1rem; resize: none; margin-right: 10px; }
        #message-input:focus { outline: none; border-color: var(--primary-color); }
        #send-button { background: var(--primary-color); border: none; color: white; font-size: 1.5rem; cursor: pointer; width: 44px; height: 44px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        #placeholder-chat { flex-grow: 1; display: flex; justify-content: center; align-items: center; text-align: center; color: var(--text-secondary-dark); }

        @media (max-width: 768px) {
            #main-app-screen { flex-direction: column; }
            #sidebar { width: 100%; height: 100%; position: absolute; z-index: 10; transform: translateX(0); transition: transform 0.3s ease-in-out;}
            #chat-window { width: 100%; height: 100%; display: flex; position: absolute; z-index: 20; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
            #main-app-screen.chat-active #sidebar { transform: translateX(-100%); }
            #main-app-screen.chat-active #chat-window { transform: translateX(0); }
            .back-arrow { display: block; }
        }
    </style>
</head>
<body>
    <!-- HTML কোড অপরিবর্তিত আছে, শুধু class="light-theme" যোগ করেছি -->
    <div id="loader-screen" class="screen active"><div class="loader"></div></div>

    <!-- আমি এখানে light-theme ক্লাসটা যোগ করেছি -->
    <div id="login-screen" class="screen light-theme">
        <h1>Welcome to ChatApp</h1>
        <button id="google-signin-btn" class="btn google-btn">Sign in with Google</button>
        <button id="phone-signin-btn" class="btn phone-btn">Sign in with Phone</button>
        <div id="phone-auth-section">
            <div id="recaptcha-container"></div>
            <div class="input-group">
                <input type="tel" id="phone-number-input" class="input-field" placeholder="Phone number (e.g., +91...)" />
                <button id="send-otp-btn" class="btn primary-btn">Send OTP</button>
            </div>
            <div class="input-group" id="otp-input-section">
                <input type="text" id="otp-input" class="input-field" placeholder="Enter 6-digit OTP" />
                <button id="verify-otp-btn" class="btn primary-btn">Verify OTP</button>
            </div>
        </div>
    </div>

    <!-- এখানেও light-theme ক্লাসটা যোগ করেছি -->
    <div id="username-screen" class="screen light-theme">
        <h2>Create Your Username</h2>
        <p>This will be your unique identity. You can't change it later.</p>
        <form id="username-form" style="width: 100%; max-width: 320px;">
            <input type="text" id="username-input" class="input-field" placeholder="@username (no spaces, lowercase)" />
            <p id="username-status"></p>
            <button type="submit" class="btn primary-btn">Save Username</button>
        </form>
    </div>

    <!-- মূল অ্যাপটা ডার্ক থিমেই থাকছে -->
    <div id="main-app-screen" class="screen">
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-tabs">
                    <button class="tab-btn active" data-tab="friends">Friends</button>
                    <button class="tab-btn" data-tab="requests">Requests</button>
                    <button class="tab-btn" data-tab="search">Search</button>
                </div>
                <input type="text" id="search-user-input" placeholder="Search by @username..." style="display:none;"/>
            </div>
            <div class="sidebar-content" id="sidebar-content"></div>
        </aside>

        <main id="chat-window">
            <div id="placeholder-chat">
                <div>
                    <h2>Select a friend to start chatting</h2>
                    <p>Your conversations are secure.</p>
                </div>
            </div>
            <header class="chat-header" style="display:none;">
                <span class="back-arrow">←</span>
                <div class="user-avatar" id="chat-avatar"></div>
                <h3 id="chat-with-username"></h3>
            </header>
            <div class="messages-container" id="messages-container">
                <div class="messages-wrapper"></div>
            </div>
            <form class="message-input-form" id="message-input-form" style="display:none;">
                <input id="message-input" placeholder="Type a message..." />
                <button id="send-button" type="submit">➤</button>
            </form>
        </main>
    </div>

    <!-- JavaScript কোড অপরিবর্তিত, কারণ লজিক একদম ঠিক ছিল -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, writeBatch, collection, query, where, getDocs, onSnapshot, updateDoc, arrayUnion, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBvmTzkKpYMhHo4Fv7_E0nzmG7_sPxztJA",
          authDomain: "abhijitchatapp.firebaseapp.com",
          projectId: "abhijitchatapp",
          storageBucket: "abhijitchatapp.firebasestorage.app",
          messagingSenderId: "987965506739",
          appId: "1:987965506739:web:343434da5af12c76c65cc6",
          measurementId: "G-S9MH55NK4N"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const screens = document.querySelectorAll('.screen');
        const googleBtn = document.getElementById('google-signin-btn');
        const phoneBtn = document.getElementById('phone-signin-btn');
        const phoneAuthSection = document.getElementById('phone-auth-section');
        const phoneInput = document.getElementById('phone-number-input');
        const sendOtpBtn = document.getElementById('send-otp-btn');
        const recaptchaContainer = document.getElementById('recaptcha-container');
        const otpInputSection = document.getElementById('otp-input-section');
        const otpInput = document.getElementById('otp-input');
        const verifyOtpBtn = document.getElementById('verify-otp-btn');
        const usernameForm = document.getElementById('username-form');
        const usernameInput = document.getElementById('username-input');
        const usernameStatus = document.getElementById('username-status');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const sidebarContent = document.getElementById('sidebar-content');
        const searchInput = document.getElementById('search-user-input');
        const mainAppScreen = document.getElementById('main-app-screen');
        const placeholderChat = document.getElementById('placeholder-chat');
        const chatHeader = document.querySelector('.chat-header');
        const chatAvatar = document.getElementById('chat-avatar');
        const chatWithUsername = document.getElementById('chat-with-username');
        const messagesWrapper = document.querySelector('.messages-wrapper');
        const messageForm = document.getElementById('message-input-form');
        const messageInput = document.getElementById('message-input');
        const backArrow = document.querySelector('.back-arrow');

        let currentUser = null;
        let currentChatFriend = null;
        let currentChatId = null;
        let unsubscribeMessages = null;
        let unsubscribeFriends = null;
        let unsubscribeRequests = null;

        const showScreen = (id) => screens.forEach(s => s.classList.toggle('active', s.id === id));

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };

        onAuthStateChanged(auth, async (user) => {
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeFriends) unsubscribeFriends();
            if (unsubscribeRequests) unsubscribeRequests();

            if (user) {
                const userDocRef = doc(db, 'users', user.uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    currentUser = { uid: user.uid, ...userDocSnap.data() };
                    showScreen('main-app-screen');
                    document.querySelector('.tab-btn[data-tab="friends"]').click();
                } else {
                    showScreen('username-screen');
                }
            } else {
                currentUser = null;
                showScreen('login-screen');
            }
        });

        googleBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => alert(`Google Sign-In Error: ${error.message}`));
        });

        phoneBtn.addEventListener('click', () => {
            phoneAuthSection.style.display = phoneAuthSection.style.display === 'block' ? 'none' : 'block';
        });

        sendOtpBtn.addEventListener('click', () => {
            sendOtpBtn.disabled = true;
            sendOtpBtn.textContent = "Sending...";
            if (!window.recaptchaVerifier) {
                window.recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaContainer, { 'size': 'invisible' });
            }
            signInWithPhoneNumber(auth, phoneInput.value, window.recaptchaVerifier)
                .then(confirmationResult => {
                    window.confirmationResult = confirmationResult;
                    alert('OTP Sent! Check your phone.');
                    otpInputSection.style.display = 'block';
                }).catch(error => {
                    alert(`Error: ${error.message}`);
                    window.recaptchaVerifier.render().then(widgetId => {
                        grecaptcha.reset(widgetId);
                    });
                }).finally(() => {
                    sendOtpBtn.disabled = false;
                    sendOtpBtn.textContent = "Send OTP";
                });
        });

        verifyOtpBtn.addEventListener('click', () => {
            if (!window.confirmationResult) return alert('Please send OTP first.');
            verifyOtpBtn.disabled = true;
            verifyOtpBtn.textContent = "Verifying...";
            window.confirmationResult.confirm(otpInput.value)
                .catch(error => alert(`OTP Error: ${error.message}`))
                .finally(() => {
                    verifyOtpBtn.disabled = false;
                    verifyOtpBtn.textContent = "Verify OTP";
                });
        });

        const checkUsername = debounce(async (username) => {
            username = username.toLowerCase();
            if (username.length < 4) {
                usernameStatus.textContent = 'Must be 4+ characters.';
                usernameStatus.className = 'error'; return;
            }
            if (!/^[a-z0-9_]+$/.test(username)) {
                usernameStatus.textContent = 'Only lowercase, numbers, and _ allowed.';
                usernameStatus.className = 'error'; return;
            }
            const ref = doc(db, 'usernames', username);
            const docSnap = await getDoc(ref);
            usernameStatus.className = docSnap.exists() ? 'error' : 'success';
            usernameStatus.textContent = docSnap.exists() ? 'Username is already taken.' : 'Username is available!';
        }, 500);

        usernameInput.addEventListener('input', () => checkUsername(usernameInput.value));

        usernameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameInput.value.toLowerCase();
            const user = auth.currentUser;
            if (!user || usernameStatus.className !== 'success') {
                alert('Please choose a valid and available username.'); return;
            }
            const batch = writeBatch(db);
            batch.set(doc(db, 'users', user.uid), {
                username: username,
                displayName: user.displayName || `User${user.uid.substring(0, 5)}`,
                photoURL: user.photoURL,
                createdAt: serverTimestamp()
            });
            batch.set(doc(db, 'usernames', username), { uid: user.uid });
            await batch.commit();
        });
        
        tabBtns.forEach(btn => btn.addEventListener('click', () => {
            tabBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const tab = btn.dataset.tab;
            searchInput.style.display = (tab === 'search') ? 'block' : 'none';
            sidebarContent.innerHTML = '';
            if (unsubscribeFriends) unsubscribeFriends();
            if (unsubscribeRequests) unsubscribeRequests();
            if (tab === 'friends') loadFriends();
            else if (tab === 'requests') loadRequests();
            else if (tab === 'search') {
                searchInput.value = '';
                sidebarContent.innerHTML = '<p style="padding: 15px; text-align: center; color: var(--text-secondary-dark);">Search for users by their @username.</p>';
            }
        }));

        const renderUserItem = (userData, type) => {
            const item = document.createElement('div');
            item.className = 'user-item';
            const userInfo = document.createElement('div');
            userInfo.className = 'user-info';
            userInfo.innerHTML = `<div class="user-avatar">${userData.username.charAt(0).toUpperCase()}</div><div><div class="user-name">@${userData.username}</div></div>`;
            const actions = document.createElement('div');
            if (type === 'friend') {
                item.onclick = (e) => {
                    if (!e.target.closest('.request-actions')) openChat(userData);
                };
            } else if (type === 'request') {
                actions.className = 'request-actions';
                actions.innerHTML = `<button class="accept-btn">Accept</button><button class="decline-btn">Decline</button>`;
                actions.querySelector('.accept-btn').onclick = (e) => { e.stopPropagation(); acceptRequest(userData.uid); };
                actions.querySelector('.decline-btn').onclick = (e) => { e.stopPropagation(); declineRequest(userData.uid); };
            } else if (type === 'search') {
                actions.innerHTML = `<button class="add-btn">Add Friend</button>`;
                actions.querySelector('button').onclick = (e) => { e.stopPropagation(); sendRequest(userData.uid); };
            }
            item.appendChild(userInfo);
            item.appendChild(actions);
            return item;
        };
        
        function loadFriends() {
            sidebarContent.innerHTML = '<div class="loader" style="margin: 20px auto;"></div>';
            const friendsRef = collection(db, 'users', currentUser.uid, 'friends');
            unsubscribeFriends = onSnapshot(friendsRef, async (snapshot) => {
                if (snapshot.empty) {
                    sidebarContent.innerHTML = '<p style="padding: 15px; text-align: center; color: var(--text-secondary-dark);">Search for users to add friends.</p>';
                } else {
                    const friendPromises = snapshot.docs.map(friendDoc => getDoc(doc(db, 'users', friendDoc.id)));
                    const friendDocs = await Promise.all(friendPromises);
                    sidebarContent.innerHTML = '';
                    friendDocs.forEach(friendDataSnap => {
                        if (friendDataSnap.exists()) sidebarContent.appendChild(renderUserItem({ uid: friendDataSnap.id, ...friendDataSnap.data() }, 'friend'));
                    });
                }
            });
        }
        
        function loadRequests() {
             sidebarContent.innerHTML = '<div class="loader" style="margin: 20px auto;"></div>';
             const requestsRef = collection(db, 'users', currentUser.uid, 'friendRequests');
             unsubscribeRequests = onSnapshot(requestsRef, async (snapshot) => {
                if (snapshot.empty) {
                    sidebarContent.innerHTML = '<p style="padding: 15px; text-align: center; color: var(--text-secondary-dark);">No new friend requests.</p>';
                } else {
                    const requestPromises = snapshot.docs.map(reqDoc => getDoc(doc(db, 'users', reqDoc.id)));
                    const requestDocs = await Promise.all(requestPromises);
                    sidebarContent.innerHTML = '';
                    requestDocs.forEach(userDataSnap => {
                         if (userDataSnap.exists()) sidebarContent.appendChild(renderUserItem({ uid: userDataSnap.id, ...userDataSnap.data() }, 'request'));
                    });
                }
            });
        }
        
        searchInput.addEventListener('input', debounce(async (e) => {
            const queryText = e.target.value.toLowerCase().trim();
            if (queryText.length < 3) return;
            sidebarContent.innerHTML = '<div class="loader" style="margin: 20px auto;"></div>';
            const q = query(collection(db, 'users'), where('username', '>=', queryText), where('username', '<=', queryText + '\uf8ff'));
            const querySnapshot = await getDocs(q);
            sidebarContent.innerHTML = '';
            if(querySnapshot.empty) sidebarContent.innerHTML = '<p style="padding: 15px; text-align: center; color: var(--text-secondary-dark);">No users found.</p>';
            else querySnapshot.docs.forEach(docSnap => {
                if (docSnap.id !== currentUser.uid) sidebarContent.appendChild(renderUserItem({ uid: docSnap.id, ...docSnap.data() }, 'search'));
            });
        }, 500));
        
        async function sendRequest(friendUid) {
            try {
                await setDoc(doc(db, 'users', friendUid, 'friendRequests', currentUser.uid), { sentAt: serverTimestamp() });
                alert('Friend request sent!');
            } catch (error) { alert('Error: ' + error.message); }
        }
        
        async function acceptRequest(friendUid) {
            const batch = writeBatch(db);
            batch.set(doc(db, 'users', currentUser.uid, 'friends', friendUid), { addedAt: serverTimestamp() });
            batch.set(doc(db, 'users', friendUid, 'friends', currentUser.uid), { addedAt: serverTimestamp() });
            batch.delete(doc(db, 'users', currentUser.uid, 'friendRequests', friendUid));
            await batch.commit();
            alert('Friend request accepted!');
        }

        async function declineRequest(friendUid) {
            await deleteDoc(doc(db, 'users', currentUser.uid, 'friendRequests', friendUid));
            alert('Friend request declined.');
        }

        function openChat(friendData) {
            currentChatFriend = friendData;
            mainAppScreen.classList.add('chat-active');
            placeholderChat.style.display = 'none';
            chatHeader.style.display = 'flex';
            messageForm.style.display = 'flex';
            chatWithUsername.textContent = '@' + friendData.username;
            chatAvatar.textContent = friendData.username.charAt(0).toUpperCase();
            currentChatId = currentUser.uid > friendData.uid ? `${currentUser.uid}_${friendData.uid}` : `${friendData.uid}_${currentUser.uid}`;
            if(unsubscribeMessages) unsubscribeMessages();
            const chatRef = doc(db, 'chats', currentChatId);
            unsubscribeMessages = onSnapshot(chatRef, (docSnap) => {
                messagesWrapper.innerHTML = '';
                if (docSnap.exists()) {
                    const { messages } = docSnap.data();
                    if (messages) {
                        messages.forEach(msg => {
                            const bubble = document.createElement('div');
                            bubble.className = 'message-bubble ' + (msg.sender === currentUser.uid ? 'my-message' : 'friend-message');
                            bubble.textContent = msg.text;
                            messagesWrapper.appendChild(bubble);
                        });
                        messagesWrapper.parentElement.scrollTop = messagesWrapper.parentElement.scrollHeight;
                    }
                }
            });
        }
        
        backArrow.addEventListener('click', () => {
            mainAppScreen.classList.remove('chat-active');
            currentChatFriend = null; currentChatId = null;
            if(unsubscribeMessages) unsubscribeMessages();
        });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '' || !currentChatId) return;
            const chatRef = doc(db, 'chats', currentChatId);
            const newMessage = { text: text, sender: currentUser.uid, createdAt: serverTimestamp() };
            try {
                const chatDoc = await getDoc(chatRef);
                const updateData = { messages: arrayUnion(newMessage) };
                if (!chatDoc.exists()) {
                    updateData.participants = [currentUser.uid, currentChatFriend.uid];
                    await setDoc(chatRef, updateData);
                } else {
                    await updateDoc(chatRef, updateData);
                }
                messageInput.value = '';
            } catch (error) { alert('Error: ' + error.message); }
        });
        
        setTimeout(() => { 
            if (auth.currentUser === null) showScreen('login-screen');
        }, 1500);
    </script>
</body>
</html>